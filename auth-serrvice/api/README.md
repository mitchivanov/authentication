# API слой

## Описание

API слой - это внешний слой приложения, который определяет точки входа в систему через HTTP интерфейс. Этот слой отвечает за обработку HTTP-запросов, валидацию входных данных и формирование HTTP-ответов. API слой не содержит бизнес-логики, а лишь делегирует выполнение операций слою приложения.

## Структура

```
api/
│
├── routes/                # Маршруты API сгруппированные по функциональности
│   ├── __init__.py       # Инициализация пакета маршрутов
│   ├── auth.py           # Маршруты аутентификации и авторизации
│   └── users.py          # Маршруты для работы с пользователями
│
├── __init__.py           # Инициализация API модуля
└── routes.py             # Корневой маршрутизатор, объединяющий все группы маршрутов
```

## Компоненты

### Маршруты API

Маршруты API определяют HTTP эндпоинты, методы и обработчики запросов:

1. **Определение эндпоинтов** - URL пути, HTTP методы, параметры запросов
2. **Валидация входных данных** - проверка запросов на соответствие схемам
3. **Обработчики запросов** - функции, обрабатывающие входящие запросы
4. **Формирование ответов** - структурирование данных для ответов клиентам

### Группировка маршрутов

Маршруты группируются по функциональным областям для лучшей организации:

1. **Аутентификация** (`auth.py`) - регистрация, вход, выход, обновление токенов
2. **Пользователи** (`users.py`) - управление пользовательскими данными
3. **Другие области** - могут быть добавлены по мере расширения функциональности

## Примеры компонентов

### Роутер аутентификации (auth.py)

```python
@router.post("/login", response_model=TokenSchema)
async def login(
    login_data: LoginSchema,
    auth_service: AuthApplicationService = Depends(get_auth_service)
):
    """
    Аутентификация пользователя и выдача JWT-токенов.
    
    Аутентифицирует пользователя по имени и паролю и возвращает токены доступа и обновления.
    """
    tokens = await auth_service.authenticate_user(login_data.username, login_data.password)
    if not tokens:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Неверное имя пользователя или пароль",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return tokens
```

### Роутер пользователей (users.py)

```python
@router.get("/me", response_model=UserInfoSchema)
async def get_current_user_info(
    current_username: str = Depends(get_current_user),
    user_service: UserApplicationService = Depends(get_user_service)
):
    """
    Получение информации о текущем авторизованном пользователе.
    
    Возвращает данные текущего пользователя на основе JWT токена.
    """
    user = await user_service.get_user_by_username(current_username)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Пользователь не найден"
        )
    return user
```

## Принципы и рекомендации

1. **Ясная документация** - каждый эндпоинт должен иметь описание, требования к параметрам и примеры ответов
2. **Валидация входных данных** - всегда проверяйте входные данные на соответствие схемам
3. **Четкие HTTP коды** - используйте соответствующие HTTP коды состояния для разных ситуаций
4. **Обработка ошибок** - предоставляйте понятные сообщения об ошибках для клиентов
5. **Зависимости через DI** - получайте сервисы через внедрение зависимостей

## Взаимодействие с другими слоями

API слой взаимодействует со слоем приложения, вызывая его сервисы для выполнения бизнес-операций:

```
Клиент --> [API слой] --> [Слой приложения] --> [Доменный слой]
                                              --> [Инфраструктурный слой]
```

API слой не должен напрямую взаимодействовать с доменным или инфраструктурным слоем, за исключением использования доменных схем для валидации данных. 