# Архитектура аутентификационного сервиса

## Общий обзор

Архитектура сервиса построена на принципах **многослойной архитектуры** (Layered Architecture) и **чистой архитектуры** (Clean Architecture). Каждый слой имеет свою чёткую ответственность и зависит только от нижележащих слоёв.

```
┌─────────────────────────────────────────────────────────┐
│                    API Layer (api/)                      │
└────────────────────────────┬────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────┐
│             Application Layer (application/)             │
└────────────────────────────┬────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────┐
│                 Domain Layer (domain/)                   │
└────────────────────────────┬────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────┐
│          Infrastructure Layer (infrastructure/)          │
└─────────────────────────────────────────────────────────┘
```

## Слои архитектуры

### 1. Доменный слой (Domain Layer)

**Местоположение**: `domain/`

**Ответственность**: Бизнес-логика и правила.

**Компоненты**:
- **Доменные сущности** (`domain/entities/`) - классы, представляющие основные бизнес-объекты системы. Содержат только бизнес-логику и не зависят от инфраструктуры.
- **Доменные сервисы** (`domain/services/`) - содержат бизнес-логику, которая не привязана к конкретной сущности или работает с несколькими сущностями.
- **Схемы** (`domain/schemas/`) - определяют структуру данных и правила валидации для входных/выходных данных API.
- **Интерфейсы** (`domain/interfaces/`) - определяют абстрактные интерфейсы для репозиториев и других компонентов инфраструктуры.
- **Модели** (`domain/models/`) - определяют доменные модели (в текущем проекте используются как модели ОРМ).

**Ключевые особенности**:
- Не имеет зависимостей от внешних слоёв или фреймворков
- Содержит чистую бизнес-логику
- Использует термины предметной области (Ubiquitous Language)

### 2. Инфраструктурный слой (Infrastructure Layer)

**Местоположение**: `infrastructure/`

**Ответственность**: Взаимодействие с внешними системами и техническими компонентами.

**Компоненты**:
- **Репозитории** (`infrastructure/repositories/`) - классы для работы с хранилищами данных.
- **База данных** (`infrastructure/database/`) - определения для работы с базой данных.
- **Конфигурация** (`infrastructure/config/`) - настройки приложения и внешних систем.
- **Middleware** (`infrastructure/middleware/`) - промежуточное ПО для HTTP запросов.
- **Утилиты** (`infrastructure/utils/`) - вспомогательные функции и классы.
- **Зависимости** (`infrastructure/dependencies/`) - провайдеры для внедрения зависимостей.

**Ключевые особенности**:
- Реализует интерфейсы, определенные в доменном слое
- Содержит технические детали работы с БД, API и другими внешними системами
- Преобразует данные между доменным форматом и форматом внешних систем

### 3. Слой приложения (Application Layer)

**Местоположение**: `application/`

**Ответственность**: Оркестровка и координация между слоями.

**Компоненты**:
- **Сервисы приложения** (`application/services/`) - оркестрируют работу между доменными сервисами и репозиториями.
  - `auth_service.py` - сервис аутентификации и авторизации
  - `user_service.py` - сервис управления пользователями

**Ключевые особенности**:
- Не содержит бизнес-логики
- Управляет транзакциями, логированием, кэшированием
- Преобразует DTO в доменные объекты и обратно

### 4. API слой (API Layer)

**Местоположение**: `api/`

**Ответственность**: Определение точек входа в приложение, HTTP-контракты.

**Компоненты**:
- **Маршруты API** (`api/routes/`) - определение эндпоинтов REST API.
  - `auth.py` - маршруты аутентификации и авторизации
  - `users.py` - маршруты управления пользователями
- **Корневой маршрутизатор** (`api/routes.py`) - объединяет все группы маршрутов.

**Ключевые особенности**:
- Не содержит бизнес-логики
- Валидирует входные данные через доменные схемы
- Обрабатывает HTTP-запросы и формирует HTTP-ответы

## Поток данных

1. HTTP-запрос поступает на API слой
2. API слой валидирует входные данные через схемы из доменного слоя
3. API вызывает соответствующий сервис приложения
4. Сервис приложения оркестрирует работу между доменными сервисами и репозиториями
5. Доменный сервис применяет бизнес-логику
6. Репозиторий из инфраструктурного слоя сохраняет/извлекает данные из БД
7. Сервис приложения преобразует доменные объекты в DTO и возвращает результат
8. API слой формирует HTTP-ответ с использованием соответствующих HTTP кодов

## Преимущества архитектуры

1. **Разделение ответственности** - каждый слой отвечает за свой аспект системы
2. **Тестируемость** - возможность тестировать бизнес-логику без зависимостей от инфраструктуры
3. **Гибкость** - можно легко заменять компоненты, не затрагивая остальную систему
4. **Изоляция** - изменения в инфраструктуре не затрагивают бизнес-логику
5. **Расширяемость** - легко добавлять новую функциональность через доменные сервисы и обработчики команд
6. **Чистые интерфейсы** - чёткие границы между слоями через абстрактные интерфейсы

## Ключевые шаблоны проектирования

1. **Репозиторий** - абстракция доступа к данным
2. **Внедрение зависимостей** - инверсия управления через DI
3. **Фабричный метод** - создание объектов через провайдеры
4. **Схема данных** - валидация входных/выходных данных
5. **Сервис** - инкапсуляция бизнес-логики 