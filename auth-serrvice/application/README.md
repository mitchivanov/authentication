# Слой приложения

## Описание

Слой приложения (Application Layer) - это слой, отвечающий за координацию взаимодействия между различными компонентами системы. Он выступает в роли оркестратора, связывающего доменную логику с инфраструктурой. В этом слое реализуются конкретные сценарии использования (use cases) приложения.

## Структура

```
application/
│
├── services/             # Сервисы приложения
│   ├── __init__.py      # Инициализация пакета сервисов
│   ├── auth_service.py  # Сервис для аутентификации и авторизации
│   └── user_service.py  # Сервис для работы с пользователями
│
└── handlers/            # Обработчики событий (опционально)
    └── ...              # Обработчики конкретных событий
```

## Компоненты

### Сервисы приложения

Сервисы приложения реализуют сценарии использования системы:

1. **Оркестрация** - координация работы между доменными сервисами и репозиториями
2. **Транзакционные границы** - управление транзакциями базы данных
3. **Аутентификация и авторизация** - проверка прав доступа, управление токенами
4. **Преобразование данных** - конвертация между DTO и доменными объектами

### Примеры сервисов

#### AuthApplicationService

```python
async def authenticate_user(self, username: str, password: str) -> Union[TokenSchema, None]:
    """
    Аутентифицировать пользователя по имени и паролю и создать токены.
    
    Args:
        username: Имя пользователя
        password: Пароль
        
    Returns:
        TokenSchema: Токены доступа и обновления или None, если аутентификация не удалась
    """
    try:
        user = await self.user_repository.get_by_username(username)
        
        if not user:
            return None
        
        if not await verify_password(password, user.password_hash):
            return None
        
        # Создаем токены доступа и обновления
        access_token, refresh_token = await create_tokens({"sub": user.username})
        
        return TokenSchema(
            access_token=access_token,
            refresh_token=refresh_token,
            token_type="bearer"
        )
    except Exception:
        return None
```

#### UserApplicationService

```python
async def register_user(
    self, 
    username: str, 
    email: str, 
    password: str, 
    date_of_birth: date
) -> UserInfoSchema:
    """
    Зарегистрировать нового пользователя.
    
    Args:
        username: Имя пользователя
        email: Email пользователя
        password: Пароль
        date_of_birth: Дата рождения
        
    Returns:
        UserInfoSchema: Зарегистрированный пользователь
        
    Raises:
        HTTPException: Если регистрация не удалась
    """
    # Проверяем, что пользователь с таким именем не существует
    existing_user = await self.user_repository.get_by_username(username)
    if existing_user:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Пользователь с таким именем уже существует"
        )
    
    # ... другие проверки и бизнес-логика ...
    
    # Хешируем пароль
    password_hash = await hash_password(password)
    
    # Создаем доменную сущность
    user = User(
        username=username,
        email=email,
        password_hash=password_hash,
        date_of_birth=date_of_birth,
        bank_balance=0.0
    )
    
    # Сохраняем пользователя через репозиторий
    created_user = await self.user_repository.create(user)
    
    # Преобразуем сущность в схему ответа
    return UserInfoSchema(
        username=created_user.username,
        email=created_user.email,
        date_of_birth=created_user.date_of_birth
    )
```

## Принципы и рекомендации

1. **Единая ответственность** - каждый сервис должен иметь одну причину для изменения
2. **Отсутствие бизнес-логики** - сервисы не содержат бизнес-правил, а лишь координируют их выполнение
3. **Трансакционность** - управление границами транзакций происходит на уровне сервисов
4. **Обработка ошибок** - сервисы должны корректно обрабатывать и преобразовывать ошибки
5. **Логирование** - сервисы должны логировать важные события и ошибки

## Взаимодействие с другими слоями

Слой приложения взаимодействует как с вышележащим API слоем, так и с нижележащими доменным и инфраструктурным слоями:

```
[API слой] --> [Слой приложения] --> [Доменный слой]
                                   --> [Инфраструктурный слой]
```

Слой приложения:
- Получает запросы от API слоя
- Использует бизнес-правила из доменного слоя
- Обращается к репозиториям и другим компонентам инфраструктурного слоя
- Возвращает результаты обратно в API слой

## Различие с доменными сервисами

Важно различать:
- **Сервисы приложения** - оркестрируют процессы, управляют транзакциями, не содержат бизнес-логики
- **Доменные сервисы** - содержат бизнес-логику, которая не относится к конкретной сущности или работает с несколькими сущностями 