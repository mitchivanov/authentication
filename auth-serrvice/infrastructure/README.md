# Инфраструктурный слой

## Описание

Инфраструктурный слой обеспечивает техническую поддержку для вышележащих слоев, реализуя взаимодействие с внешними системами и ресурсами. Этот слой содержит код, зависящий от конкретных технологий и фреймворков, таких как базы данных, внешние API, файловая система, и т.д. Инфраструктурный слой изолирует технические детали от доменной логики.

## Структура

```
infrastructure/
│
├── config/                 # Конфигурация приложения
│   ├── __init__.py        # Инициализация модуля конфигурации
│   ├── database.py        # Конфигурация базы данных
│   └── settings.py        # Настройки приложения
│
├── database/               # Компоненты для работы с базой данных
│   └── __init__.py        # Инициализация модуля базы данных
│
├── repositories/           # Репозитории для доступа к данным
│   ├── __init__.py        # Инициализация модуля репозиториев
│   └── user_repository.py # Репозиторий пользователей
│
├── dependencies/           # Зависимости для внедрения
│   ├── __init__.py        # Инициализация модуля зависимостей
│   └── services.py        # Провайдеры сервисов
│
├── middleware/             # Промежуточное ПО для HTTP запросов
│   ├── __init__.py        # Инициализация модуля middleware
│   ├── auth.py            # Middleware для аутентификации
│   └── rate_limit.py      # Middleware для ограничения частоты запросов
│
└── utils/                  # Утилиты и вспомогательные функции
    ├── __init__.py        # Инициализация модуля утилит
    └── security.py        # Утилиты для безопасности
```

## Компоненты

### Репозитории

Репозитории обеспечивают абстракцию доступа к данным:

1. **Интерфейс данных** - предоставляют унифицированный интерфейс для работы с данными
2. **Персистентность** - реализуют сохранение и извлечение данных из хранилища
3. **Трансляция** - преобразуют данные между форматом хранилища и доменными сущностями

Пример репозитория:

```python
class UserRepository(UserRepositoryInterface):
    def __init__(self, session: AsyncSession):
        self.session = session

    async def get_by_username(self, username: str) -> Optional[User]:
        stmt = select(User).where(User.username == username)
        result = await self.session.execute(stmt)
        return result.scalar_one_or_none()

    async def create(self, user: User) -> User:
        self.session.add(user)
        await self.session.commit()
        await self.session.refresh(user)
        return user
```

### Конфигурация

Компоненты конфигурации управляют настройками приложения:

1. **Переменные среды** - загрузка и валидация переменных окружения
2. **Настройки базы данных** - параметры подключения к БД
3. **Настройки безопасности** - ключи шифрования, параметры JWT
4. **Прочие настройки** - другие конфигурационные параметры

### Middleware

Компоненты промежуточного ПО обрабатывают HTTP запросы:

1. **Аутентификация** - проверка JWT токенов, валидация CSRF
2. **Ограничение запросов** - защита от DoS атак
3. **Логирование** - запись информации о запросах
4. **Обработка ошибок** - унифицированная обработка исключений

### Утилиты

Вспомогательные функции для различных технических задач:

1. **Безопасность** - хеширование паролей, создание токенов
2. **Валидация** - дополнительные функции валидации
3. **Форматирование** - преобразование данных

Пример утилит безопасности:

```python
async def hash_password(password: str) -> str:
    """Хеширует пароль с использованием bcrypt."""
    return pwd_context.hash(password)

async def verify_password(plain_password: str, hashed_password: str) -> bool:
    """Проверяет соответствие пароля хешу."""
    return pwd_context.verify(plain_password, hashed_password)
```

## Зависимости

Компоненты для внедрения зависимостей (DI):

1. **Провайдеры сервисов** - фабрики для создания экземпляров сервисов
2. **Провайдеры репозиториев** - фабрики для создания экземпляров репозиториев

```python
async def get_user_repository(session: AsyncSession = Depends(get_session)):
    """Зависимость для получения репозитория пользователей."""
    return UserRepository(session)

async def get_auth_service(user_repository = Depends(get_user_repository)):
    """Зависимость для получения сервиса аутентификации."""
    return AuthApplicationService(user_repository)
```

## Принципы и рекомендации

1. **Инверсия зависимостей** - зависимость от абстракций, а не от конкретных реализаций
2. **Изоляция технологий** - скрытие технических деталей от вышележащих слоев
3. **Тестируемость** - возможность подмены компонентов для тестирования
4. **Конфигурируемость** - гибкая настройка компонентов через внешние конфигурации

## Взаимодействие с другими слоями

Инфраструктурный слой взаимодействует с доменным и прикладным слоями:

```
[Слой приложения] --> [Инфраструктурный слой] <-- [Доменный слой]
                                                     (интерфейсы)
```

Инфраструктурный слой:
- Реализует интерфейсы, определенные в доменном слое
- Предоставляет техническую реализацию для слоя приложения
- Не должен зависеть от бизнес-логики доменного слоя 